ARG BASE_IMAGE=arkes:base

FROM ${BASE_IMAGE}

ARG UUID

RUN <<EOT
  set -e
  rm /home
  mkdir /home
  /usr/lib/system/setup_live_user
  mkdir -p /etc/mkinitcpio{,.conf}.d
  cp -lf \
    /etc/system/mkinitcpio-archiso.conf \
    /etc/mkinitcpio.conf.d/archiso.conf
  cp -lf \
    /etc/system/linux-zen-archiso.preset \
    /etc/mkinitcpio.d/linux-zen.preset
  cp -lf \
    /etc/system/pacman-initialize.service \
    /etc/systemd/system/pacman-initialize.service
  systemctl enable pacman-initialize.service
EOT

# Base tools needed for instllation
RUN /usr/lib/system/package_layer \
  arch-install-scripts \
  edk2-shell \
  grub \
  man-db \
  man-pages \
  memtest86+ \
  memtest86+-efi \
  mkinitcpio-archiso \
  mtools \
  qemu-guest-agent \
  syslinux

# All the possible filesystems
RUN /usr/lib/system/package_layer \
  btrfs-progs \
  dosfstools \
  exfatprogs \
  exfat-utils \
  f2fs-tools \
  e2fsprogs \
  jfsutils \
  mtd-utils \
  nilfs-utils \
  ntfs-3g \
  udftools \
  xfsprogs \
  bcachefs-tools \
  apfsprogs \
  bcachefs-dkms \
  linux-apfs-rw-dkms

RUN <<EOT
  set -e
  sed -i '/11-dm-initramfs.rules/d' /usr/lib/initcpio/install/archiso
  /usr/lib/system/build_kernel
  /usr/lib/system/create_live_bootloader
  systemctl disable atomic-state-overlay.service
  printf '%s\n' \
    "#!/bin/bash" \
    "mount -o remount,size=\$(awk '/^MemTotal:/{print int(\$2*0.7)}' /proc/meminfo)K /run/archiso/cowspace" \
  > /bin/resize-cowspace
  chmod +x /bin/resize-cowspace
  printf '%s\n' \
    "[Unit]" \
    "After=local-fs.target" \
    "[Service]" \
    "ExecStart=/bin/resize-cowspace" \
    "RemainAfterExit=true" \
    "Type=oneshot" \
    "[Install]" \
    "WantedBy=multi-user.target" \
  > /etc/systemd/system/resize-cowspace.service
  systemctl enable resize-cowspace.service
EOT
